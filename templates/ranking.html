<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% load static %}
<link rel="stylesheet" href="{% static 'css/global.css' %}">
<link rel="stylesheet" href="{% static 'css/ranking.css' %}">

<div class="container mt-4">

    <a href="/" class="btn-simpson d-inline-block mb-5">Volver</a>

    <div id="tier-container">
        <div class="tier-row d-flex">
            <div class="tier-label s-tier">S</div>
            <div class="tier-content sortable-list"></div>
        </div>
        <div class="tier-row d-flex">
            <div class="tier-label a-tier">A</div>
            <div class="tier-content sortable-list"></div>
        </div>
        <div class="tier-row d-flex">
            <div class="tier-label b-tier">B</div>
            <div class="tier-content sortable-list"></div>
        </div>
        <div class="tier-row d-flex">
            <div class="tier-label c-tier">C</div>
            <div class="tier-content sortable-list"></div>
        </div>
        <div class="tier-row d-flex">
            <div class="tier-label d-tier">D</div>
            <div class="tier-content sortable-list"></div>
        </div>
        <div class="tier-row d-flex">
            <div class="tier-label e-tier">E</div>
            <div class="tier-content sortable-list"></div>
        </div>
        <div class="tier-row d-flex">
            <div class="tier-label f-tier">F</div>
            <div class="tier-content sortable-list"></div>
        </div>
    </div>

    <div class="mt-5 p-4 bg-dark rounded shadow">
        <h3 class="text-white mb-3">Personajes Disponibles</h3>
        <div id="character-pool" class="sortable-list d-flex flex-wrap gap-2">

            {% for c in characters %}
                <div class="tier-card" data-id="{{ c.code }}">
                    <img src="
                            {% if 'http' in c.image %}{{ c.image }}{% else %}https://cdn.thesimpsonsapi.com/500{{ c.image }}{% endif %}"
                         alt="{{ c.name }}"
                         title="{{ c.name }}"
                         style="width: 80px; height: 80px; object-fit: contain; padding: 5px;">
                </div>
            {% endfor %}

        </div>
    </div>

    <form id="ranking-form" method="POST" action="{% url 'guardar_ranking' %}">
        {% csrf_token %}
        <input type="hidden" name="category_code" value="{{ category_code }}">
        <input type="hidden" name="ranking_data" id="ranking-data">

        <div class="text-center mt-4 mb-5">
            <button type="submit" class="btn-simpson">Guardar y Salir</button>
        </div>
    </form>

</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    const lists = document.querySelectorAll('.sortable-list');
    lists.forEach(list => {
        new Sortable(list, {
            group: 'shared',
            animation: 150,
            ghostClass: 'ghost'
        });
    });

    document.getElementById('ranking-form').addEventListener('submit', function (e) {
        const characterPool = document.getElementById('character-pool');
        const remainingCharacters = characterPool.querySelectorAll('.tier-card').length;

        if (remainingCharacters > 0) {
            e.preventDefault();
            alert("¡Mosquis! Tienes que clasificar a todos los personajes en algún Tier antes de guardar.");
            return;
        }

        const tierData = {};
        const rows = document.querySelectorAll('.tier-row');
        let totalAsignados = 0;

        rows.forEach(row => {
            const tierLabel = row.querySelector('.tier-label').innerText.trim();
            const cards = row.querySelectorAll('.tier-card');
            const ids = Array.from(cards).map(card => card.getAttribute('data-id'));

            tierData[tierLabel] = ids;
            totalAsignados += ids.length;
        });

        if (totalAsignados === 0) {
            e.preventDefault();
            alert("¡Ouch! El ranking está vacío.");
            return;
        }

        const confirmacion = confirm("¿Estás seguro de que este es tu ranking definitivo?");
        if (!confirmacion) {
            e.preventDefault();
        } else {
            document.getElementById('ranking-data').value = JSON.stringify(tierData);
        }
    });
</script>